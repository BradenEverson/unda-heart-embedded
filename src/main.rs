use std::{error::Error, time::Instant};

use esp_idf_svc::hal::{adc::{attenuation, config::Config, AdcChannelDriver, AdcDriver}, delay::FreeRtos, gpio::{Level, PinDriver}, peripherals::Peripherals};
use esp_idf_unda::network::{activations::Activations, network::Network};

fn main() -> Result<(), Box<dyn Error>> {
    // It is necessary to call this function once. Otherwise some patches to the runtime
    // implemented by esp-idf-sys might not link properly. See https://github.com/esp-rs/esp-idf-template/issues/71
    esp_idf_svc::sys::link_patches();

    // Bind the log crate to the ESP Logging facilities
    esp_idf_svc::log::EspLogger::initialize_default();

    //Set IO
    let peripherals = Peripherals::take()?;

    let mut adc = AdcDriver::new(peripherals.adc1, &Config::new().calibration(true))?;
    let mut pulse_sensor: AdcChannelDriver<{attenuation::DB_11}, _> = AdcChannelDriver::new(peripherals.pins.gpio4)?;

    let mut led = PinDriver::output(peripherals.pins.gpio12)?; 
    let mut led2 = PinDriver::output(peripherals.pins.gpio13)?; 
    let mut led3 = PinDriver::output(peripherals.pins.gpio14)?; 
    

    //Serialized models can be loaded here either from explicity Unda string or file if board has an SD card slot
    let model_str = "D|32|4|-2.7968729 1.8641616 2.5622299 0.46683145 0.6401885 4.8107624 -3.0174303 -2.9501514 -0.5884438 0.16249086 1.1509912 1.4979758 -3.1130562 -3.1344755 2.4676142 -0.8702574 -2.2799423 0.25312224 0.3185337 0.57665074 -2.1297355 -2.4781978 4.879801 -3.2214239 4.2113624 0.29253626 -0.1105366 -0.18058859 -1.9140966 -1.5082687 0.7561274 0.34847394 -1.6752352 1.9200389 0.72712564 1.2328064 -0.07278065 -0.8319703 2.2477958 0.8528673 3.7182531 0.21384902 1.434265 0.61557263 2.6218283 3.2280505 1.3939391 -0.6158328 -2.8829958 0.06369851 0.22814834 -3.5133686 -0.17856953 -0.608907 -2.4115777 -0.18493111 -0.4532326 2.096507 1.8478669 3.8306067 1.9184254 -3.8118505 -1.2492355 -0.904536 3.3446748 -2.4793072 2.3143265 -5.3205185 -0.93800956 1.2878895 -0.6988512 2.809091 2.3722208 5.739168 0.0893684 -1.669955 -0.8303971 -1.6618379 -1.0648695 2.0202596 0.3197692 1.5107079 0.37437084 -1.9239393 -2.3787484 1.1642927 -2.8541172 0.3958324 -3.0877001 2.1741388 1.7696265 -0.7195288 -1.6174889 0.33962178 0.5094674 -1.5809636 -3.3989823 0.502926 -0.102240615 -1.4031358 -0.618258 2.3284469 1.9204026 0.48294848 -3.6485696 -4.197129 -0.117907524 2.459861 1.7850007 -0.029139591 -4.9366345 0.527419 -1.1578444 0.13771155 -1.9076606 0.85633343 0.14675242 0.82658595 4.1631346 -0.45357537 5.594601 -0.8084193 -5.794634 -2.350968 -2.611216 -3.7292693 -3.9351814 0.48124048|-0.94535804 -0.8601463 -0.73595595 0.6665156 0.76140547 0.8984966 -0.1569655 0.49072027 0.79576993 0.46676612 0.26773643 -0.86869574 0.07144284 -0.096924305 0.23945689 0.37890768 0.8881757 0.6236489 0.07015753 0.4527974 0.24902534 0.8183143 -0.4772153 -0.7041998 0.52599263 0.2603898 -0.5853236 0.2098813 0.36236882 -0.21996641 0.85491323 0.39762378#D|64|32|-13136.412 -23108.549 -13347.949 23112.756 -11365.135 12337.238 -13582.738 4857.385 -15034.724 -9554.293 -12336.876 -14048.041 11617.699 -16153.848 -13467.008 15334.236 3688.7222 -19178.176 -14562.631 -8156.592 -12756.799 -29084.488 -12730.906 -1419.8625 -2877.9958 -13521.012 9427.741 -39302.094 -23607.035 -11600.78 -24553.066 14001.783 -13039.1875 -23034.064 -13258.53 23203.74 -11271.624 12457.939 -13492.003 4954.6685 -14944.045 -9462.743 -12245.899 -13956.181 11742.454 -16081.967 -13378.25 15395.091 3800.8655 -19097.121 -14474.612 -8090.675 -12659.864 -29031.496 -12636.099 -1307.7511 -2765.3408 -13428.241 9493.923 -39289.164 -23548.016 -11505.372 -24524.557 14046.411 12182.916 22589.105 12312.831 -24083.94 10296.663 -13589.1875 12546.155 -6081.353 14056.444 8435.865 11273.746 13045.086 -12786.057 15129.636 12433.149 -16208.128 -4893.09 18305.807 13590.286 7063.6216 11764.317 28591.096 11828.884 271.98877 1765.8601 12496.314 -10283.049 39036.27 22801.191 10526.343 23929.125 -14820.41 11982.757 22219.094 12105.069 -23645.854 10129.322 -13330.215 12330.413 -5963.4766 13823.055 8295.935 11083.509 12823.412 -12547.283 14859.072 12220.413 -15926.163 -4796.7354 17989.943 13365.903 6934.023 11575.909 28097.072 11636.283 280.30475 1750.234 12283.458 -10103.439 38347.3 22403.906 10351.586 23497.498 -14568.043 12736.396 23015.688 12931.432 -23937.35 10915.306 -13187.612 13170.75 -5553.569 14654.818 9063.085 11900.443 13652.836 -12384.351 15852.2705 13054.894 -16000.235 -4398.154 18905.625 14187.597 7704.4517 12345.26 29133.445 12343.571 798.202 2299.6013 13109.338 -10062.183 39656.816 23463.336 11152.257 24577.037 -14613.23 -13024.285 -22952.77 -13243.405 23072.129 -11263.828 12368.764 -13470.227 4889.393 -14917.522 -9464.327 -12231.172 -13934.831 11684.888 -16029.544 -13357.748 15332.499 3757.898 -19051.328 -14449.674 -8079.8604 -12641.693 -28915.785 -12623.058 -1330.018 -2782.7805 -13410.388 9435.75 -39089.156 -23466.445 -11493.408 -24395.926 13992.71 -12993.041 -22993.518 -13188.475 23148.51 -11209.045 12454.368 -13421.323 4988.1157 -14883.793 -9401.51 -12180.971 -13889.364 11726.938 -15980.343 -13308.33 15381.396 3827.0342 -19028.22 -14409.088 -8010.113 -12605.142 -28951.248 -12592.254 -1278.7374 -2740.4429 -13365.703 9485.417 -39163.566 -23452.584 -11441.801 -24391.623 14043.184 -12884.57 -22807.008 -13091.757 23050.79 -11123.378 12408.02 -13323.685 4966.523 -14765.01 -9327.759 -12086.321 -13787.771 11705.247 -15877.024 -13208.963 15320.9795 3823.972 -18884.97 -14299.137 -7940.8994 -12500.612 -28731.86 -12481.782 -1239.5026 -2689.1213 -13261.656 9483.512 -38875.902 -23285.889 -11353.073 -24241.473 13988.115 -13014.105 -22899.59 -13230.626 22968.64 -11258.288 12290.363 -13456.375 4848.433 -14900.21 -9465.321 -12223.82 -13918.894 11610.187 -15999.25 -13341.48 15254.058 3710.3975 -19018.102 -14430.218 -8086.9966 -12629.235 -28847.625 -12607.868 -1360.7229 -2807.641 -13397.147 9354.643 -38969.418 -23416.025 -11487.045 -24335.424 13919.922 -12999.916 -22996.1 -13200.183 23160.256 -11217.015 12452.214 -13432.59 4984.9756 -14890.357 -9404.298 -12186.568 -13901.157 11732.463 -15990.782 -13317.824 15392.355 3822.875 -19036.107 -14415.838 -8017.765 -12611.22 -28958.957 -12598.373 -1281.5634 -2743.027 -13373.197 9493.06 -39171.723 -23463.01 -11448.113 -24400.488 14054.876 -12930.578 -22826.926 -13140.664 23010.018 -11174.669 12350.972 -13368.313 4915.672 -14812.528 -9380.142 -12133.925 -13831.912 11668.2705 -15915.205 -13253.853 15290.561 3774.9038 -18919.533 -14344.895 -7986.9546 -12547.944 -28748.148 -12529.51 -1288.6989 -2736.1926 -13309.114 9421.8125 -38860.39 -23315.336 -11403.465 -24254.172 13955.53 -13035.53 -22954.992 -13267.82 23081.984 -11282.134 12355.854 -13489.967 4864.383 -14933.624 -9487.388 -12251.663 -13955.281 11686.904 -16066.416 -13375.949 15300.349 3735.4583 -19066.508 -14466.16 -8112.707 -12650.862 -28918.98 -12628.758 -1338.2454 -2788.6023 -13429.576 9420.475 -39105.754 -23486.016 -11520.146 -24441.146 13967.66 -12971.184 -22757.65 -13196.743 22772.188 -11237.045 12154.362 -13408.003 4738.0083 -14843.729 -9456.386 -12189.171 -13871.289 11500.546 -15949.071 -13303.082 15102.647 3633.9512 -18933.266 -14376.807 -8083.174 -12585.184 -28670.607 -12563.108 -1394.0735 -2829.9746 -13355.11 9298.808 -38725.004 -23298.414 -11463.028 -24200.322 13787.747 -12807.172 -22639.871 -13015.236 22830.416 -11062.922 12275.509 -13240.726 4900.8677 -14672.054 -9278.563 -12018.069 -13701.369 11586.102 -15771.572 -13126.858 15180.721 3769.3113 -18755.045 -14211.326 -7906.2046 -12431.632 -28526.31 -12409.097 -1255.3771 -2695.0425 -13181.25 9373.139 -38579.867 -23121.557 -11291.533 -24061.504 13855.327 -12992.9795 -22995.885 -13191.129 23160.613 -11208.653 12454.646 -13419.702 4989.7847 -14881.658 -9395.816 -12179.782 -13890.627 11737.712 -15980.372 -13310.835 15391.576 3827.9937 -19028.62 -14408.813 -8013.4614 -12603.064 -28954.846 -12592.946 -1274.7438 -2734.0977 -13366.41 9494.718 -39167.332 -23454.484 -11442.27 -24392.943 14052.91 -12827.495 -22599.98 -13037.828 22746.94 -11093.996 12183.86 -13255.886 4811.697 -14686.638 -9317.016 -12040.378 -13717.59 11501.833 -15791.878 -13147.33 15106.878 3706.0176 -18752.295 -14222.053 -7943.617 -12443.329 -28472.691 -12427.194 -1312.4567 -2747.9456 -13197.97 9342.671 -38475.77 -23104.527 -11317.342 -24011.793 13788.771 -12979.256 -22947.273 -13188.622 23162.738 -11211.773 12459.343 -13419.227 4971.746 -14869.754 -9401.317 -12177.856 -13889.572 11752.444 -16002.687 -13305.141 15390.85 3827.0232 -19012.898 -14405.697 -8020.5815 -12594.651 -28923.906 -12573.934 -1266.3824 -2725.1885 -13359.233 9512.263 -39141.535 -23446.174 -11441.961 -24422.688 14050.604 -13166.103 -23193.617 -13384.537 23307.922 -11387.576 12491.424 -13611.081 4930.485 -15074.003 -9567.421 -12360.168 -14080.318 11795.614 -16201.419 -13494.052 15484.096 3793.3057 -19248.658 -14600.177 -8160.6563 -12770.946 -29225.537 -12756.523 -1347.3881 -2817.1135 -13551.625 9536.536 -39483.777 -23714.662 -11617.598 -24643.244 14137.419 -13049.2 -23023.521 -13270.366 23188.887 -11284.786 12434.809 -13499.612 4928.467 -14949.598 -9476.892 -12255.104 -13966.222 11740.889 -16081.667 -13381.75 15389.337 3781.2761 -19094.824 -14481.598 -8092.001 -12664.914 -28998.273 -12637.97 -1315.8264 -2770.07 -13437.542 9507.453 -39233.797 -23531.412 -11515.673 -24506.025 14048.265 -12977.723 -22906.484 -13184.338 23102.215 -11211.88 12403.89 -13410.347 4940.252 -14863.922 -9402.39 -12172.698 -13879.449 11701.887 -15968.798 -13296.869 15344.704 3796.236 -18993.563 -14391.609 -8032.308 -12588.818 -28866.574 -12576.238 -1294.3342 -2748.0847 -13352.126 9436.973 -39033.72 -23407.555 -11440.158 -24351.629 14002.813 -13121.271 -23155.295 -13331.418 23224.418 -11336.453 12443.663 -13561.895 4924.607 -15024.722 -9524.986 -12313.582 -14030.776 11732.23 -16139.208 -13448.625 15420.609 3772.522 -19190.125 -14544.026 -8147.1943 -12725.581 -29137.246 -12715.96 -1347.2716 -2812.9622 -13503.41 9479.269 -39397.676 -23633.197 -11573.481 -24574.588 14086.289 11903.423 22034.09 12031.426 -23454.967 10069.9795 -13220.316 12255.041 -5885.93 13727.37 8252.582 11014.127 12741.094 -12457.807 14782.053 12146.699 -15789.038 -4754.8916 17875.836 13274.124 6931.322 11488.544 27906.867 11552.07 280.26712 1739.5056 12205.262 -10022.762 38090.883 22264.625 10286.134 23330.846 -14439.777 -13142.789 -23107.959 -13349.339 23100.57 -11366.321 12328.996 -13584.69 4855.02 -15034.047 -9558.877 -12339.605 -14049.663 11606.525 -16148.07 -13471.054 15325.369 3682.8745 -19183.258 -14566.567 -8158.0166 -12756.773 -29082.98 -12735.343 -1426.2208 -2886.1597 -13525.832 9424.483 -39292.465 -23609.93 -11603.927 -24546.494 14001.357 -12993.107 -22990.086 -13190.76 23144.633 -11209.092 12448.02 -13424.361 4984.219 -14881.1045 -9401.989 -12180.83 -13891.635 11727.785 -15980.92 -13310.716 15379.555 3821.0435 -19027.379 -14408.546 -8012.711 -12607.829 -28947.479 -12593.341 -1280.264 -2741.2144 -13367.319 9482.238 -39155.34 -23449.459 -11444.326 -24387.49 14041.629 -13053.095 -23003.848 -13281.076 23151.06 -11293.253 12412.895 -13506.495 4898.224 -14955.138 -9490.185 -12263.354 -13969.33 11726.024 -16089.666 -13389.5205 15361.813 3769.3938 -19099.295 -14482.449 -8116.797 -12670.114 -28992.596 -12638.975 -1324.2863 -2783.2332 -13442.623 9466.328 -39221.223 -23535.088 -11525.404 -24493.623 14020.724 -12987.86 -22948.828 -13198.635 23174.342 -11221.369 12446.951 -13422.947 4965.2217 -14874.99 -9408.193 -12181.648 -13890.0625 11749.575 -15982.878 -13309.106 15415.08 3822.1436 -19010.455 -14405.862 -8010.4146 -12599.232 -28901.129 -12584.159 -1279.3187 -2738.4402 -13362.919 9515.206 -39084.246 -23431.88 -11447.723 -24379.387 14073.482 -13000.412 -22921.908 -13230.868 23016.383 -11251.116 12342.7295 -13465.379 4865.529 -14902.1875 -9460.52 -12226.765 -13923.16 11659.505 -16054.401 -13349.604 15242.73 3734.5095 -19030.549 -14433.837 -8108.993 -12629.753 -28895.156 -12592.679 -1329.0068 -2777.8835 -13396.299 9396.222 -39120.14 -23459.043 -11492.124 -24447.643 13910.872 -12942.888 -22921.186 -13142.282 23111.223 -11162.395 12438.242 -13372.566 4991.752 -14824.15 -9358.489 -12131.366 -13840.387 11716.499 -15930.34 -13259.915 15359.672 3831.031 -18961.963 -14356.151 -7980.0176 -12557.67 -28862.443 -12540.726 -1257.6975 -2716.1042 -13315.23 9476.954 -39055.023 -23377.723 -11399.706 -24325.953 14026.329 -13000.082 -22995.984 -13199.724 23157.258 -11216.965 12450.385 -13428.914 4983.5205 -14890.492 -9407.535 -12186.382 -13901.145 11730.023 -15988.907 -13317.506 15389.285 3822.1404 -19035.408 -14416.549 -8019.1504 -12611.926 -28956.568 -12597.849 -1281.4147 -2745.2349 -13373.489 9494.922 -39169.492 -23461.477 -11450.19 -24399.934 14052.281 -12995.958 -23000.256 -13205.287 23189.766 -11220.451 12473.283 -13436.416 4995.282 -14894.401 -9408.926 -12192.235 -13905.704 11750.535 -16007.121 -13323.405 15410.286 3829.806 -19041.572 -14422.346 -8023.9526 -12615.156 -28969.623 -12597.507 -1272.9124 -2732.3137 -13379.276 9505.051 -39209.63 -23474.87 -11454.789 -24434.143 14069.805 -13042.881 -22976.463 -13265.519 23111.818 -11283.757 12376.226 -13495.467 4884.598 -14939.965 -9487.329 -12256.331 -13960.326 11693.041 -16075.297 -13382.539 15323.736 3744.3452 -19079.594 -14476.564 -8106.4585 -12664.54 -28945.291 -12630.37 -1339.7905 -2789.7495 -13435.262 9446.654 -39158.37 -23501.438 -11520.801 -24467.064 13983.769 -13073.177 -23013.549 -13295.746 23107.691 -11312.621 12386.118 -13517.457 4874.4063 -14967.624 -9502.892 -12278.394 -13984.666 11703.472 -16095.687 -13407.022 15334.767 3751.3596 -19109.3 -14497.197 -8116.7705 -12682.818 -29010.465 -12661.491 -1346.8772 -2806.0476 -13460.153 9452.797 -39199.773 -23550.338 -11541.996 -24472.662 14004.376 -13045.558 -22971.492 -13271.62 23105.941 -11290.497 12371.466 -13499.067 4873.6445 -14943.077 -9490.929 -12260.994 -13961.881 11698.986 -16075.89 -13384.545 15316.668 3740.877 -19078.8 -14472.27 -8115.3994 -12662.997 -28944.46 -12634.602 -1338.6324 -2786.963 -13436.508 9430.657 -39139.688 -23500.807 -11523.013 -24462.078 13980.899 12013.651 22294.191 12148.711 -23776.207 10153.185 -13429.281 12384.133 -6015.1978 13873.078 8323.874 11126.3545 12873.622 -12643.594 14932.209 12269.682 -15991.14 -4834.1943 18070.898 13411.974 6982.698 11609 28213.588 11658.561 242.82799 1715.4625 12330.556 -10113.393 38563.8 22508.063 10386.427 23650.35 -14624.046 -13025.71 -22976.332 -13236.263 23142.764 -11257.208 12414.936 -13461.603 4930.5547 -14912.8 -9450.999 -12224.045 -13928.851 11713.612 -16016.649 -13347.614 15391.742 3791.7927 -19054.418 -14442.947 -8052.3975 -12636.899 -28939.615 -12622.05 -1311.918 -2771.9126 -13401.534 9483.8545 -39115.477 -23475.766 -11488.462 -24393.477 14048.108 -12937.288 -22732.326 -13166.095 22786.04 -11209.944 12171.948 -13391.734 4757.652 -14814.005 -9432.563 -12170.596 -13848.558 11494.156 -15949.543 -13277.149 15072.272 3636.7583 -18904.484 -14355.165 -8082.3184 -12562.71 -28651.857 -12530.177 -1381.0516 -2815.7551 -13328.186 9270.299 -38736.082 -23280.89 -11439.864 -24228.947 13749.963 -13056.013 -23028.436 -13273.793 23199.066 -11292.566 12441.753 -13498.378 4931.0645 -14954.475 -9478.122 -12260.896 -13969.649 11739.191 -16080.711 -13388.907 15410.904 3795.3923 -19104.635 -14482.993 -8087.9253 -12669.31 -29014.744 -12654.288 -1320.6151 -2781.1807 -13439.833 9511.8125 -39234.01 -23544.834 -11520.546 -24486.158 14070.146 -13108.792 -23135.314 -13315.932 23243.645 -11322.613 12468.162 -13545.239 4960.383 -15010.285 -9504.099 -12298.759 -14016.242 11750.415 -16115.452 -13430.481 15441.713 3795.4675 -19174.365 -14533.38 -8109.5073 -12718.931 -29129.775 -12705.017 -1334.083 -2800.7234 -13487.053 9505.405 -39386.152 -23622.744 -11554.593 -24551.635 14095.773 -13087.532 -23076.898 -13296.843 23233.008 -11315.341 12458.066 -13523.914 4939.8438 -14981.769 -9495.664 -12278.296 -13994.613 11748.7295 -16102.682 -13411.528 15442.748 3795.4246 -19137.354 -14511.041 -8094.9644 -12696.57 -29074.557 -12683.568 -1330.9708 -2799.6997 -13469.8125 9522.904 -39288.637 -23582.525 -11540.604 -24513.729 14095.066 -13078.948 -23068.352 -13293.432 23154.88 -11310.444 12402.885 -13532.353 4908.9478 -14988.215 -9503.323 -12286.794 -13997.341 11680.999 -16121.39 -13418.158 15359.658 3751.0747 -19131.332 -14513.62 -8127.0005 -12698.679 -29059.568 -12671.956 -1357.7083 -2816.7896 -13468.115 9442.225 -39312.664 -23576.52 -11547.258 -24557.318 14022.699 12171.9375 22550.125 12305.191 -24021.438 10291.568 -13542.472 12536.94 -6047.1216 14046.27 8440.366 11266.871 13033.236 -12746.513 15119.057 12426.284 -16161.229 -4863.35 18285.063 13579.4375 7076.8174 11758.952 28530.68 11811.591 284.51947 1773.6744 12488.61 -10237.518 38970.29 22771.371 10523.41 23894.896 -14773.831 -13048.477 -23028.895 -13262.129 23233.506 -11277.524 12477.91 -13482.784 4957.6724 -14941.989 -9460.487 -12241.9795 -13951.27 11774.668 -16065.537 -13371.989 15443.661 3821.9124 -19093.98 -14471.487 -8070.97 -12654.49 -29026.729 -12643.234 -1299.8805 -2764.2239 -13428.467 9530.627 -39234.13 -23539.594 -11504.2 -24471.732 14090.803 -13286.204 -23369.781 -13489.087 23342.365 -11485.536 12473.065 -13716.956 4910.38 -15193.463 -9652.23 -12464.781 -14193.097 11771.454 -16291.744 -13608.322 15524.61 3751.154 -19384.926 -14714.727 -8235.455 -12888.2295 -29407.39 -12876.8 -1424.5762 -2903.9226 -13664.178 9509.526 -39703.074 -23858.414 -11717.871 -24762.98 14174.712 -13086.873 -23134.434 -13307.952 23319.223 -11313.157 12533.264 -13549.357 4983.4966 -15003.881 -9498.583 -12295.485 -14015.47 11810.815 -16166.2295 -13431.228 15479.06 3828.0688 -19173.896 -14533.841 -8114.918 -12710.861 -29161.146 -12679.655 -1301.7712 -2765.841 -13486.404 9549.422 -39464.918 -23648.084 -11553.446 -24650.48 14134.25 -13086.425 -23074.465 -13295.947 23151.852 -11310.15 12393.202 -13531.744 4903.0244 -14983.248 -9504.536 -12285.395 -13998.939 11675.188 -16109.156 -13418.617 15363.837 3746.7456 -19133.266 -14511.386 -8125.3105 -12700.955 -29053.875 -12678.589 -1363.0591 -2821.5994 -13472.627 9442.95 -39290.938 -23570.57 -11547.178 -24530.65 14028.975 -13068.248 -23089.373 -13270.751 23221.207 -11283.16 12469.031 -13501.647 4973.3716 -14966.24 -9466.706 -12256.11 -13972.133 11749.96 -16072.286 -13390.293 15430.592 3810.0916 -19124.266 -14488.351 -8073.3906 -12678.441 -29075.654 -12664.409 -1313.0739 -2776.4182 -13445.601 9504.157 -39322.707 -23571.16 -11515.68 -24503.408 14086.773 -13136.671 -23102.496 -13345.656 23096.855 -11365.4375 12324.507 -13579.804 4852.253 -15035.89 -9557.444 -12336.8 -14046.648 11605.179 -16145.647 -13469.697 15323.086 3680.8298 -19174.688 -14560.102 -8155.4585 -12755.746 -29073.639 -12731.726 -1428.0248 -2884.4148 -13520.979 9419.748 -39281.074 -23602.756 -11600.773 -24541.395 13994.071 -12993.233 -23000.404 -13200.649 23187.135 -11216.173 12469.557 -13434.054 4994.978 -14888.864 -9403.615 -12186.637 -13900.798 11749.047 -16003.257 -13318.456 15406.098 3832.0137 -19033.615 -14415.964 -8022.0044 -12610.371 -28962.533 -12590.425 -1272.273 -2731.2664 -13372.802 9502.734 -39198.598 -23468.236 -11451.065 -24426.49 14063.712 12139.014 22484.867 12267.362 -23936.244 10269.796 -13490.732 12507.919 -6021.1147 14010.447 8418.109 11242.977 12999.112 -12695.198 15080.412 12392.099 -16096.847 -4838.398 18231.885 13545.233 7069.1265 11728.867 28448.152 11780.48 294.3034 1778.8031 12458.064 -10184.455 38845.387 22702.732 10498.75 23830.082 -14718.33 -13125.74 -23161.916 -13336.238 23230.057 -11341.845 12446.965 -13563.792 4926.5103 -15025.981 -9525.392 -12315.662 -14031.683 11736.072 -16142.249 -13453.063 15423.998 3772.5808 -19194.18 -14549.101 -8147.4155 -12727.467 -29146.23 -12718.308 -1347.8273 -2812.3647 -13504.328 9481.738 -39404.297 -23641.182 -11577.897 -24578.244 14085.223 12673.541 23001.236 12856.529 -24058.652 10834.2705 -13321.937 13091.193 -5678.204 14595.304 8971.469 11819.101 13579.028 -12509.212 15755.735 12979.157 -16114.794 -4515.804 18852.521 14116.081 7626.981 12274.827 29119.605 12285.839 698.61786 2207.7766 13036.344 -10095.74 39654.703 23416.48 11067.897 24504.307 -14717.954 -12282.046 -21575.602 -12494.163 21566.428 -10631.582 11548.046 -12694.552 4511.4443 -14056.814 -8941.346 -11536.038 -13131.087 10925.066 -15096 -12593.094 14323.7705 3480.234 -17939.43 -13609.287 -7649.4844 -11907.856 -27177.244 -11895.251 -1291.9869 -2654.8171 -12641.044 8839.675 -36743.063 -22083.168 -10846.301 -22916.41 13078.107 -13105.45 -23134.982 -13318.419 23327.389 -11327.247 12526.74 -13543.783 4973.9385 -15009.303 -9502.409 -12292.926 -14013.232 11811.237 -16133.397 -13431.928 15511.39 3845.0227 -19179.74 -14534.458 -8111.096 -12709.435 -29157.375 -12701.624 -1303.9141 -2780.31 -13488.902 9578.076 -39433.02 -23643.756 -11552.359 -24586.566 14162.853 -12879.377 -22733.518 -13095.371 22915.207 -11136.146 12320.928 -13320.766 4888.385 -14760.053 -9349.801 -12094.23 -13785.265 11642.271 -15887.38 -13208.431 15206.6045 3769.3674 -18859.9 -14293.842 -7987.0693 -12499.762 -28674.443 -12477.521 -1273.2632 -2717.354 -13266.33 9390.475 -38769.453 -23260.105 -11366.208 -24196.463 13877.836 -13029.49 -23006.97 -13244.222 23223.338 -11257.466 12469.988 -13475.3545 4956.8555 -14929.727 -9446.989 -12231.856 -13941.017 11765.519 -16055.997 -13363.146 15420.592 3816.2712 -19080.797 -14457.334 -8080.504 -12645.325 -29000.389 -12624.653 -1288.7568 -2752.4126 -13413.144 9496.988 -39229.97 -23522.695 -11490.079 -24483.645 14077.891 -12999.514 -23003.688 -13200.521 23181.564 -11218.968 12466.119 -13433.379 4992.544 -14894.8545 -9407.052 -12188.344 -13902.732 11742.486 -15999.122 -13318.046 15404.372 3833.197 -19041.3 -14419.535 -8024.0254 -12609.971 -28967.51 -12597.673 -1275.6586 -2733.6658 -13374.296 9498.988 -39193.617 -23473.049 -11450.095 -24421.418 14062.395 12259.648 22661.322 12387.266 -24080.037 10379.13 -13540.176 12616.602 -6021.6577 14134.45 8509.138 11348.224 13119.358 -12749.248 15198.168 12503.546 -16215.718 -4841.2144 18380.1 13665.335 7124.2466 11840.95 28658.27 11901.47 329.18195 1830.0741 12571.892 -10293.924 39087.41 22877.332 10600.21 23970.895 -14828.554 12040.135 22287.68 12179.338 -23779.744 10191.026 -13392.792 12411.386 -5969.446 13900.448 8357.116 11157.339 12899.929 -12608.692 14968.448 12301.625 -15980.6875 -4803.368 18091.934 13437.34 7037.8115 11639.503 28203.361 11686.76 287.76056 1760.4493 12358.304 -10078.407 38513.35 22522.016 10420.072 23647.46 -14597.6455 -13102.991 -23131.055 -13308.834 23241.898 -11319.736 12471.097 -13538.492 4959.8975 -15005.852 -9500.557 -12295.272 -14012.043 11750.584 -16111.48 -13427.518 15442.4 3798.6482 -19170.627 -14529.74 -8105.025 -12715.673 -29125.758 -12698.708 -1328.2101 -2797.9907 -13486.374 9505.084 -39380.906 -23616.877 -11552.016 -24545.98 14093.121 -12905.327 -22794.236 -13110.169 23061.553 -11145.242 12381.424 -13332.465 4940.2124 -14777.085 -9347.542 -12101.8 -13797.208 11681.476 -15877.008 -13222.785 15333.325 3799.3362 -18887.533 -14310.704 -7955.636 -12516.119 -28702.492 -12504.948 -1268.3492 -2714.7524 -13278.044 9457.78 -38798.766 -23271.824 -11371.733 -24198.174 13996.622 12308.445 22442.342 12463.692 -23508.916 10492.085 -13058.277 12683.5625 -5619.5767 14159.919 8659.213 11441.242 13165.128 -12297.185 15232.554 12575.641 -15800.825 -4496.199 18328.568 13697.098 7305.482 11898.29 28367.281 11940.892 594.9346 2069.573 12636.175 -9944.452 38590.332 22750.625 10706.66 23762.129 -14441.111 -13294.936 -23381.879 -13500.749 23349.783 -11498.49 12473.336 -13729.563 4907.9707 -15208.367 -9664.144 -12474.097 -14205.86 11769.177 -16303.855 -13621.289 15527.811 3744.2905 -19397.635 -14729.927 -8241.621 -12899.226 -29421.467 -12886.31 -1432.3015 -2913.7163 -13675.615 9512.15 -39720.535 -23873.508 -11729.956 -24775.334 14181.536 -13051.165 -23070.084 -13256.135 23221.764 -11267.356 12477.183 -13489.581 4981.373 -14949.968 -9453.088 -12239.995 -13954.496 11756.819 -16059.007 -13374.585 15426.893 3821.3225 -19107.832 -14472.414 -8065.5737 -12662.963 -29051.85 -12648.446 -1298.8672 -2761.405 -13432.878 9510.27 -39300.5 -23549.244 -11501.181 -24487.14 14086.94 -13284.112 -23372.842 -13486.774 23355.535 -11488.768 12482.543 -13719.96 4916.088 -15200.195 -9652.496 -12466.931 -14195.815 11777.515 -16295.742 -13609.229 15535.299 3754.8477 -19391.31 -14716.955 -8232.627 -12890.7 -29416.533 -12875.683 -1423.8282 -2903.61 -13667.03 9520.193 -39717.3 -23863.844 -11717.708 -24768.633 14186.909|-12162.771 -12071.138 11092.139 10905.536 11723.762 -12056.665 -12003.421 -11912.236 -12047.555 -12011.871 -11960.986 -12078.269 -12017.354 -11844.159 -12004.161 -11868.934 -12004.347 -12186.024 -12081.611 -11999.266 -12138.017 10841.206 -12165.64 -12003.993 -12089.758 -12006.945 -12052.637 -11958.7705 -12012.509 -12016.855 -12081.763 -12104.705 -12084.917 10946.359 -12045.85 -11996.237 -12083.197 -12120.419 -12104.747 -12111.268 11088.89 -12067.439 -12286.837 -12119.909 -12110.767 -12080.457 -12161.809 -12012.732 11060.554 -12141.007 11639.76 -11370.815 -12120.156 -11922.616 -12056.393 -12013.631 11166.809 10979.42 -12117.265 -11927.757 11264.226 -12297.332 -12066.129 -12286.919#D|16|64|57.357018 6.4054337 -12353.323 -12131.314 -12223.059 19.015528 6.367642 -19.80105 3.6967134 2.2198243 4.1645126 -9.830997 -0.025205167 7.4717097 4.6094236 9.694663 19.724138 2.7127619 35.611248 2.4793906 70.245895 -12036.388 49.34054 3.4681978 21.231575 -7.2769136 -1.9688765 3.5737069 -0.63873106 1.1026527 3.8625636 -1.9084976 -8.919382 -12188.941 32.07795 -8.588803 32.134613 2.0019765 36.658627 73.53662 -12329.486 44.98424 13.586546 51.308697 54.696663 10.543285 49.601887 0.9912853 -12282.93 67.95492 -12205.422 10.578355 73.62459 -5.2246346 27.571457 5.669365 -12370.426 -12213.614 4.608998 22.421465 -12045.281 12.408274 6.5222545 16.142 33.323193 10.960834 -12308.729 -12115.065 -12108.032 24.908634 -4.9540353 18.236418 23.544296 5.9866724 26.982079 70.95168 80.967705 -11.107881 -1.1835564 4.126333 8.10312 1.9571213 86.74103 -17.291039 110.32277 -12033.433 50.455524 0.9787226 74.564926 67.28951 51.06441 -5.896667 5.40906 2.348513 83.76085 -0.13464145 67.31798 -12285.513 20.552103 50.902737 -2.3751252 9.503984 -2.7375505 78.689804 -12295.441 -13.594923 11.435666 89.79088 68.675186 1.4553046 48.13982 2.7489946 -12316.925 106.805595 -12129.093 14.422124 -46.89615 1.6963055 -20.127779 -1.3929083 -12329.587 -12174.452 11.828326 -2.1458507 -11966.034 9.244143 0.61156833 8.308569 -28.484955 5.0209036 -12372.799 -12163.2295 -12036.107 -12.660937 -11.20136 -20.30982 -13.128583 -6.4010634 -25.919857 -9.592746 -26.478806 -27.908676 -13.967719 -39.52323 -19.61416 -10.524928 -4.1172132 -10.56245 -11.229784 -12064.458 -28.746845 -8.804913 -16.231506 -8.539753 18.931984 -14.784475 -6.4494424 -1.7679017 0.01792867 -11.185688 -9.550868 -12231.93 -14.173491 15.608871 -16.963305 -0.10639759 -16.520498 -15.989808 -12349.011 -12.395358 7.8951054 -21.952757 -20.548618 -7.7124815 -30.349092 -4.372403 -12318.201 -12.522831 -12018.419 -25.172653 -61.319027 -12.515417 -21.618105 -9.324381 -12324.332 -12234.107 1.0388261 -32.578487 -12015.964 4.7520385 -5.369503 4.545064 62.041256 14.841687 -12372.615 -12137.931 -12257.066 14.556769 12.400028 -20.516777 13.545381 9.906539 6.920013 -7.537955 -11.697738 7.1820736 15.329329 3.0395813 5.186197 -6.5501933 46.36805 23.800962 78.46395 -12036.847 50.48463 13.487692 9.178426 14.555269 -2.5933597 13.620269 9.95299 7.45956 14.594046 -10.030459 -4.1588545 -12190.554 34.742775 -7.241994 18.797995 11.165269 33.306683 82.89858 -12341.181 42.067085 14.631339 44.98247 68.46345 17.181759 50.371265 6.510683 -12280.151 79.0574 -12235.452 1.8952092 67.62446 -11.314649 28.314775 10.761984 -12368.174 -12220.148 12.301917 17.396553 -12058.277 13.249731 13.276348 14.361139 -28.77967 7.266707 -12371.642 -12162.774 -12029.627 -16.200527 -7.9853992 -18.016506 -12.18129 -7.367328 -25.403759 -9.202853 -29.775854 -28.081238 -9.724071 -39.532993 -25.032774 -12.5811405 -11.04386 -16.080984 -6.52599 -12063.621 -31.05104 -13.61862 -17.81518 -11.627635 17.149687 -17.75466 -6.1861644 -8.009499 -4.8568025 -9.639954 -10.432211 -12230.052 -16.930807 15.393904 -17.705618 -1.1209854 -19.660732 -13.173977 -12345.135 -14.791093 7.1507444 -19.726898 -18.946724 -3.9749827 -27.018915 -6.408291 -12320.328 -8.920415 -12014.637 -27.897331 -65.40968 -10.818413 -24.212793 -12.602475 -12324.143 -12231.707 3.7485533 -32.874123 -12012.919 7.088432 -3.4135897 6.5479703 -74.91549 11.935815 -12308.365 -12203.204 -11658.527 -4.8206196 -46.638668 -40.54165 3.3891153 -40.932156 -50.752125 46.43248 52.51466 -47.74465 -46.95448 34.977364 -37.19299 27.194807 -62.75186 -0.09336476 -37.219856 -12039.624 -93.92066 -45.980732 47.710888 -107.4151 73.96022 -55.61432 -40.95558 -32.22074 38.63834 34.577915 47.54508 -12154.626 -89.70393 73.525665 -5.241775 -17.1822 31.394625 -26.662024 -12336.047 71.167854 18.105799 16.82897 -64.29644 -28.789375 -92.55025 -32.2833 -12223.585 -37.781796 -11721.357 -159.72203 -24.431293 25.995365 -1.7766995 -37.005505 -12246.387 -12213.494 -18.668901 -21.960838 -11946.32 20.131739 -27.911232 16.82709 48.107697 -9.965653 -12300.614 -12105.444 -12170.775 27.835234 -14.82225 33.5732 15.667495 -16.090166 22.113474 55.084618 77.209076 -0.9604763 -13.736595 17.202093 20.263586 15.693293 65.2936 -50.87587 37.578133 -12034.442 47.05513 -13.740928 77.27439 67.419785 31.361593 -13.85321 -14.238972 -20.993824 67.385826 11.449356 55.201427 -12253.211 4.0065513 24.959352 11.772596 -11.994049 14.337338 53.70026 -12287.849 3.4009542 13.799418 86.32101 38.16665 -13.930159 49.442234 -19.964806 -12310.627 33.992836 -12112.556 16.029076 56.235306 6.760913 -3.3228664 -14.996169 -12335.757 -12153.888 -15.121948 15.360103 -11993.324 15.003222 -13.267167 14.589024 65.74313 22.35983 -12387.548 -12137.7295 -12261.542 12.771056 20.792023 -10.343963 20.97621 17.342857 13.746069 -3.6538103 -20.677696 5.073858 19.860964 -3.6699977 1.2003155 -15.007948 60.317875 42.156776 80.05276 -12028.519 52.129166 21.476694 -0.2585675 25.192602 -1.3367435 17.850164 17.497807 15.195976 29.237999 -16.580597 -0.10489919 -12181.087 33.36734 -7.21617 11.4887705 20.71053 36.940163 92.6041 -12346.033 47.577152 11.444236 46.616936 68.87513 20.291946 50.87851 13.626911 -12268.566 79.20672 -12250.367 -4.2531133 65.76946 -17.835585 32.418274 20.319899 -12362.175 -12223.093 19.365553 11.581834 -12061.31 12.891886 20.895815 13.960997 -37.5836 8.054571 -12369.052 -12156.803 -12071.485 -10.471426 -6.5177603 -16.854246 -1.3249937 -2.8369691 -20.211576 -2.8507128 -24.875578 -13.356461 -9.01958 -30.720901 -15.136876 -9.9844265 14.98134 -0.9946027 -15.917303 -12051.083 -38.259434 -8.266453 -10.469584 9.487167 25.658768 -14.103692 -2.676748 -5.6534204 22.955181 -5.4095902 -1.7091966 -12204.617 -1.4259132 14.958679 -9.826329 4.782265 -14.052204 -15.707424 -12345.572 0.30426666 9.267717 -21.109745 -18.571346 -2.583958 -37.92457 -3.9413514 -12320.307 -10.628811 -12066.072 -5.595781 -56.946373 -6.769639 -22.533583 -7.904491 -12317.436 -12229.307 5.1231995 -34.457108 -12013.178 9.694844 -3.7393777 6.1102633 52.355778 -8.330279 -12289.583 -12127.34 -12055.334 30.092607 -14.898578 29.5116 12.053751 -17.303215 26.820427 56.385223 86.2406 -1.2790623 -17.483463 -5.887539 19.039473 15.893499 64.34054 -56.055923 37.728935 -12029.09 52.439342 -15.768247 41.471264 69.58963 7.593663 -16.072739 -14.212536 -17.927721 60.442116 12.924519 57.449516 -12260.183 -2.333492 -2.0903118 9.036515 -13.460319 13.064118 52.914066 -12314.213 -1.8045177 16.402874 87.72114 39.19315 -8.764533 49.54651 -19.304373 -12305.069 33.604076 -11995.213 14.00426 49.191208 3.8339891 -4.394082 -15.472809 -12352.235 -12168.005 -13.346835 -2.5808492 -11983.116 12.943303 -14.071905 15.559576 60.657772 13.714155 -12372.063 -12140.626 -12243.162 17.575615 9.383941 -21.118387 10.565554 3.3450875 5.1305842 -12.681067 -14.614971 7.35445 10.190746 5.979764 13.293819 -4.363619 38.768734 15.36326 74.8166 -12041.986 46.054718 8.230639 8.839667 2.3356986 -6.741805 8.662547 5.9072003 7.2945323 8.689742 -5.592561 -9.054572 -12180.012 38.534325 -12.229504 21.384615 8.963735 36.09265 79.8139 -12339.927 48.372326 12.589945 40.330368 61.354824 10.494205 43.87489 5.180798 -12282.228 74.34584 -12218.838 6.40774 67.10616 -9.653271 29.384008 8.662019 -12366.555 -12217.855 9.43063 19.940405 -12054.817 15.018611 8.358828 16.161776 97.04754 1.0748128 -12440.427 -12296.001 -12071.383 -107.218994 -26.32965 79.221634 -114.664085 -23.652523 -75.226974 16.11979 35.91373 -159.91362 -30.223885 -26.673105 -21.589289 -30.888737 -10.350294 -138.10951 42.8483 -12107.407 98.70826 -27.318071 37.783257 24.638708 21.014095 -32.892246 -22.975386 -19.212633 -5.402247 -31.386831 15.341775 -12410.237 -150.16731 12.351639 -47.021374 -10.931304 -106.33163 42.69533 -12362.669 -174.8342 3.3492305 61.987225 13.101159 -23.568653 101.34568 -18.915916 -12473.707 42.285606 -12123.449 -22.376083 -88.10456 -31.64331 -25.947746 -26.082819 -12303.152 -12116.878 -15.383999 -86.504364 -11975.688 4.083142 -23.206955 2.890437 65.59712 -7.9711747 -12378.968 -12112.722 -12147.546 20.589334 31.644934 29.706244 16.246492 35.32503 30.715294 26.93112 3.786295 64.325714 33.786312 38.251644 17.62889 47.053444 86.212494 78.481995 141.97148 -12026.1 52.0753 29.925936 25.861773 39.176872 26.129406 33.331104 34.74819 38.84035 48.04636 38.356186 32.341927 -12155.12 76.166 21.385748 11.630936 51.631683 40.84506 90.01596 -12339.126 69.483536 11.576143 77.6695 93.13488 39.119957 49.405056 39.23911 -12261.916 140.69286 -12201.208 45.828514 54.569893 39.196777 -18.384193 32.64988 -12364.479 -12190.647 51.212547 8.7664995 -12030.181 14.574146 40.111855 13.128741 47.952984 -9.7096 -12355.918 -12035.488 -11830.169 27.4399 -14.561699 26.526907 16.699173 -15.555262 27.926817 54.899944 95.600655 -6.656114 -18.93994 30.538067 22.109642 17.9225 63.141575 -55.700943 36.218426 -12102.924 50.87066 -13.893302 30.760696 67.503204 -0.62678653 -16.52675 -15.878333 -17.712862 64.82215 15.821418 60.421913 -12160.506 -1.7607185 17.32529 8.298879 -14.966879 18.84138 53.350826 -12337.395 3.228516 13.973126 86.99684 38.383945 -13.033066 51.218185 -16.28482 -12312.404 32.848785 -11770.738 40.408577 47.22515 8.387344 -3.5992157 -15.685752 -12360.707 -12055.665 -12.78831 20.510887 -11791.872 14.322538 -15.056623 16.29305 60.44348 -14.222319 -12300.267 -12111.765 -12150.079 29.704264 -5.099972 46.52941 0.24002501 -3.416984 -0.6830816 57.414536 64.53532 -5.071437 -8.018676 5.975725 4.02162 12.457226 46.45171 -42.599632 47.685467 -12042.235 62.73594 -3.8943543 57.929283 53.77018 21.548758 -4.9489326 -5.2876153 -11.775167 46.24256 10.621079 55.14674 -12258.194 4.692886 18.267881 19.679024 -6.43749 -0.20065673 61.1367 -12296.076 -19.938124 13.450562 95.48903 50.61415 -5.6791277 61.514675 -11.423596 -12340.673 46.150898 -12095.198 29.850565 34.50603 1.5476261 -4.010709 -8.138211 -12346.223 -12147.03 -5.968313 4.201106 -11993.387 14.393471 -9.363616 13.242828 -63.010128 -14.39262 -12360.804 -12134.229 -12175.059 14.57017 -3.865092 -18.496153 20.757114 -4.5807977 -0.8229744 23.972033 -6.3462906 18.632433 -3.3389547 -1.9868926 4.971902 11.091155 56.712296 20.51617 -47.15976 -12042.372 -61.332005 -6.0995584 10.133604 66.31388 9.889789 -6.474836 -6.443056 -12.074542 66.82445 9.03365 23.632412 -12143.496 29.997221 2.2564564 -3.3435488 -3.6500702 25.867126 -24.494493 -12331.026 47.314556 14.440386 -25.040892 -9.305382 -3.0437834 -62.012943 -10.852937 -12300.573 -44.628204 -12113.399 3.7777267 62.49401 1.0857182 -5.1573634 -7.0263653 -12324.572 -12234.575 -6.284545 -12.731892 -12041.848 15.135511 -6.2928443 15.533595|-12249.45 -12150.343 -12023.981 -12266.184 -12019.702 -11749.99 -12245.926 -12260.121 -12071.599 -12128.518 -12260.458 -12134.94 -12284.035 -11906.961 -12231.719 -12225.895#D|1|16|22.97078 8.486312 0.4290365 33.288193 0.39362302 18.687252 11.070457 33.84174 0.8974936 1.4519665 26.098831 16.784204 49.92754 8.5990305 8.988702 3.8915412|-22.322111";
    //age - 'hyper'ish parameter for age of patient
    //sex
    let age = 19f32;
    let sex = 0f32;

    let mut model = Network::deserialize_unda_fmt_string(model_str.into(), Activations::SIGMOID); 

    let threshold = 3000;
    let mut beat_detected = false;
    let mut last_beat_time = Instant::now();
    let mut bpm;
    let mut led_state = Level::Low;


    //Collect params from IO and generate inferences!
    loop {
        let in_val = adc.read(&mut pulse_sensor)?;

        if in_val > threshold && !beat_detected {
            beat_detected = true;
            let curr_time = Instant::now();
            let beat_interval = curr_time
            .duration_since(last_beat_time);
            last_beat_time = curr_time;

            if beat_interval.as_secs_f32() > 0.0 {
                bpm = 60.0 / beat_interval.as_secs_f32();
                if bpm < 220f32 {
                    log::info!("BPM: {}", bpm);
                    
                    led_state = match led_state {
                        Level::Low => Level::High,
                        _ => Level::Low
                    };
                    led.set_level(led_state)?;
                    led1.set_level(led_state)?;
                    led2.set_level(led_state)?;
                    

                    //Perform inference
                    log::info!("{} - {} - {} - {}", age / 100f32, sex, bpm / 200f32, beat_interval.as_secs_f32());
                    let data = vec![age / 100f32, sex, bpm / 200f32, beat_interval.as_secs_f32()];
                    
                    let heart_attack_risk = model.predict(&data)[0];

                    log::info!("{}", heart_attack_risk);

                    if heart_attack_risk >= 0.85 {
                        //Heart attack likely
                        loop {
                            for _ in 0..10{
                                led.set_high()?;
                                led2.set_high()?;
                                led3.set_high()?;
                                FreeRtos::delay_ms(50);
                                led.set_low()?;
                                led2.set_low()?;
                                led3.set_low()?;
                                FreeRtos::delay_ms(50);
                            }
                        }
                    }
                }
            }
        } else {
            beat_detected = false;
        }


        //Delay timer
        FreeRtos::delay_ms(5);
    }
}
